<!DOCTYPE html>
<html lang="en">
    <head>
        <!-- Métas-datas -->
        <meta charset="UTF-8">
        
        <!-- Favicon -->
        <link rel="shortcut icon" href="images/favicon.png" />
        
        <!-- CSS -->
        <link rel="stylesheet" href="css/bootstrap.min.css" />
        
        <!-- JS -->
        <script type="text/javascript" src="js/jquery-2.2.0.min.js"></script>
        <script type="text/javascript" src="js/bootstrap.min.js"></script>
        <script type="text/javascript" src="js/clipboard.min.js"></script>
        
        <!-- Titre -->
        <title>Emploi du temps - Génerateur de lien ICS - Université Bordeaux - Licence Informatique</title>
    </head>
    <body onload="document.getElementById('inputResultat').value = window.location.href;">
        <div id="params" class="container auth">
            <!-- Titre du formulaire -->
            <h1 class="text-center">Générateur de lien pour agenda</h1>
            
            <!-- Erreurs -->
            <div id="errors">
                <!--        -->
            </div>
            
            <!-- Formulaire -->
            <div id="big-form" class="well auth-box">
                <form>
                    <fieldset>

                        <!-- Select Semestre -->
                        <div id="divSemestre" class="form-group">
                            <label class="control-label" for="selectSemestre">Sélectionnez le semestre</label>
                            <div class="">
                                <select id="selectSemestre" name="selectbasic" class="form-control">">
                                    <option value="" selected disabled hidden>Semestre</option>
                                    <option value="MI101">Semestre 1</option>
                                    <option value="MI201">Semestre 2</option>
                                    <option value="IN300">Semestre 3</option>
                                    <option value="IN400">Semestre 4</option>
                                    <option value="IN501">Semestre 5</option>
                                    <option value="IN601">Semestre 6</option>
                                </select>
                            </div>
                        </div>

                        <!-- Select Groupe TD -->
                        <div id="divGroupe" style="display: none;" class="form-group">
                            <label class="control-label" for="selectGroupe">Sélectionnez le groupe de TD</label>
                            <div class="">
                                <select id="selectGroupe" name="selectbasic" class="form-control">
                                    <!--        -->
                                </select>
                            </div>
                        </div>

                        <!-- Multiple Checkboxes Modules -->
                        <div id="divModules" class="form-group" style="display: none;">
                            <label class="control-label" for="checkboxes">Choisissez les modules <u style="font-size: larger;">à exclure</u> du calendrier</label>
                            <div id="contentModules" class="">
                                <!--        -->
                            </div>
                        </div>
                        
                        <div id="divAnglais" class="form-group" style="display: none;">
                            <label class="control-label" for="checkboxeAnglais">
                                Salle d'anglais personnalisée ?
                                <input id="checkboxeAnglais" type="checkbox" style="margin-left: 10px;" onchange='document.getElementById("inputAnglais").disabled = !this.checked;'>
                            </label>
                            <div class="">
                                <input id="inputAnglais" class="form-control" type="number" disabled min="0" style="width: 100px;">
                            </div>
                        </div>

                        <!-- Sous-groupes spécifiques au S6 -->
                        <div id="divSousGroupes" style="display: none;">

                            <!-- Multiple Radios (inline) Groupe BD -->
                            <div id="divGroupeBD" class="form-group">
                                <label class="control-label" for="groupeBD">Quel est votre groupe de BD ?</label>
                                <div class=""> 
                                    <label class="radio-inline" for="groupeBD-1">
                                        <input name="groupeBD" id="groupeBD-1" value="1" checked="checked" type="radio">
                                        Groupe 1
                                    </label> 
                                    <label class="radio-inline" for="groupeBD-2">
                                        <input name="groupeBD" id="groupeBD-2" value="2" type="radio">
                                        Groupe 2
                                    </label>
                                </div>
                            </div>

                            <!-- Multiple Radios (inline) Groupe Algo -->
                            <div id="divGroupeAlgo" class="form-group">
                                <label class="control-label" for="groupeAlgo">Etes vous dans le "groupe 4" d'algo ?</label>
                                <div class=""> 
                                    <label class="radio-inline" for="groupeAlgo-4">
                                        <input name="groupeAlgo" id="groupeAlgo-4" value="4" type="radio">
                                        Oui
                                    </label> 
                                    <label class="radio-inline" for="groupeAlgo-0">
                                        <input name="groupeAlgo" id="groupeAlgo-0" value="0" checked="checked" type="radio">
                                        Non
                                    </label>
                                </div>
                            </div>

                            <!-- Multiple Radios (inline) Groupe AS&PP3 -->
                            <div id="divGroupeAS" class="form-group">
                                <label class="control-label" for="groupeAS">Etes vous dans le "groupe 4" d'analyse syntaxique ?</label>
                                <div class=""> 
                                    <label class="radio-inline" for="groupeAS-4">
                                        <input name="groupeAS" id="groupeAS-4" value="4" type="radio">
                                        Oui
                                    </label> 
                                    <label class="radio-inline" for="groupeAS-0">
                                        <input name="groupeAS" id="groupeAS-0" value="0" checked="checked" type="radio">
                                        Non
                                    </label>
                                </div>
                            </div>

                        </div>

                        <!-- Text input Résultat-->
                        <div id="divResultat" class="form-group">
                            <label class="control-label" for="inputResultat">URL calendrier</label>  
                            <div class="input-group">
                                <input id="inputResultat" name="textinput" class="form-control input-md" type="text" readonly>
                                
                                <!-- Bouton de copie -->
                                <span class="input-group-btn">
                                    <button id="copyButton" class="btn btn-default" type="button" data-clipboard-demo data-clipboard-target="#inputResultat" title="Copier vers le presse-papier" alt="Copier">
                                        <span class="glyphicon glyphicon-copy" aria-hidden="true"></span>
                                    </button>
                                </span>
                            </div>
                            <span class="help-block">
                                URL à copier dans la partie "abonnement" de votre gestionnaire de calendrier
                            </span>  
                        </div>

                    </fieldset>
                </form>
            </div>
        
            <!-- Référence à HackJack -->
            <div style="width: 100%; text-align: right; font-style: italic; color: #CCCCCC;">
                Données provenant de <a style=";" href="http://hackjack.info/et/">HackJack</a>
            </div>
            
            <div class="clearfix"></div>
        </div>

        <!-- JS -->
        <script type="text/javascript">
            // Objet Clipboard pour gérer la copie
            var clipboard = new Clipboard('#copyButton');
            
            // Gestion des erreurs
            document.getElementById("copyButton").onclick=function(){
                // Semestre invalide
                if(document.getElementById("contentModules").innerHTML == "error")
                {
                    var span1 = document.createElement("span");
                    
                    var strong1 = document.createElement("strong");
                    strong1.innerHTML = "Attention !";

                    span1.appendChild(strong1);
                    span1.appendChild(document.createTextNode(' Veuillez choisir un semestre en cours.'));
                    
                    erreur('danger', span1);
                }
                
                // Semestre non sélectionné
                else if(document.getElementById("selectSemestre").value == "")
                {
                    var span2 = document.createElement("span");
                    
                    var strong2 = document.createElement("strong");
                    strong2.innerHTML = "Attention !";

                    span2.appendChild(strong2);
                    span2.appendChild(document.createTextNode(' Vous avez oublié de sélectionner un semestre.'));
                    
                    erreur('danger', span2);
                }
                
                // Groupe non sélectionné
                else if(document.getElementById("selectGroupe").value == "")
                {
                    var span3 = document.createElement("span");
                    
                    var strong3 = document.createElement("strong");
                    strong3.innerHTML = "Attention !";

                    span3.appendChild(strong3);
                    span3.appendChild(document.createTextNode(' Vous avez oublié de sélectionner un groupe de TD.'));
                    
                    erreur('danger', span3);
                }
                
                // Copie...
                else
                {
                    // ...réussie
                    clipboard.on('success', function(e) {
                        var span4 = document.createElement("span");

                        span4.appendChild(document.createTextNode(' Url du calendrier copiée dans le presse-papier.'));

                        erreur('success', span4);
                    });
            
                    // ...échouée
                    clipboard.on('error', function(e) {
                        var span5 = document.createElement("span");

                        var strong5 = document.createElement("strong");
                        strong5.innerHTML = "Attention !";

                        span5.appendChild(strong5);
                        span5.appendChild(document.createTextNode(' La copie n\'a pas fonctionnée, l\'URL n\'a pas été copiée dans le presse-papier.'));

                        erreur('warning', span5);                        
                    });
                }
            };
            
            // Affichage d'un message d'erreur (type = {danger, warning, info, success})
            function erreur(type, message)
            {
                // Nettoyage de la div d'erreurs
                document.getElementById("errors").innerHTML = '';
                
                var error = document.createElement("div");
                error.setAttribute("class", "alert alert-" + type + " alert-dismissible fade in");
                error.setAttribute("role", "alert");

                var button = document.createElement("button");
                button.setAttribute("class", "close");
                button.setAttribute("type", "button");
                button.setAttribute("data-dismiss", "alert");
                button.setAttribute("aria-label", "Close");

                var span = document.createElement("span");
                span.setAttribute("aria-hidden", "true");
                span.innerHTML = "x";
                
                //

                document.getElementById("errors").appendChild(error);
                error.appendChild(button);
                button.appendChild(span);
                error.appendChild(message);
            }

            // Récupération de la liste des modules
            $('#selectSemestre').change(function() {
                // Récupération du code du module
                var sem = document.getElementById("selectSemestre").value;
                
                // Récupération de la liste des modules en AJAX
                $.post("modules.php", { semester: sem }, function(data) {
                    // Si le semestre n'est pas valide
                    if(data == "error")
                    {
                        // Afficher l'erreur correspondante
                        var span1 = document.createElement("span");
                    
                        var strong1 = document.createElement("strong");
                        strong1.innerHTML = "Attention !";

                        span1.appendChild(strong1);
                        span1.appendChild(document.createTextNode(' Veuillez choisir un semestre en cours.'));

                        erreur('danger', span1);
                        
                        document.getElementById("divModules").style.display = 'none';
                        document.getElementById("divAnglais").style.display = 'none';
                    }
                    
                    // Si le semestre est valide
                    else
                    {
                        // Nettoyage de la div d'erreurs et de la liste des modules
                        document.getElementById("errors").innerHTML = '';
                        document.getElementById('contentModules').innerHTML = '';
                        
                        // Afficahge de la div contenant la liste des modules
                        document.getElementById("divModules").style.display = 'block';
                        document.getElementById("divAnglais").style.display = 'block';
                        
                        // Création du contenu de la liste des modules
                        var dataParse = JSON.parse(data);
                        
                        for(var key in dataParse) {
                            var checkboxDiv = document.createElement("div");
                            checkboxDiv.setAttribute("class", "checkbox");
                            
                            var checkboxLabel = document.createElement("label");
                            checkboxLabel.setAttribute("for", "checkboxes-" + key);
                            
                            var checkboxInput = document.createElement("input");
                            checkboxInput.setAttribute("id", "checkboxes-" + key);
                            checkboxInput.setAttribute("name", "modules[]");
                            checkboxInput.setAttribute("type", "checkbox");
                            checkboxInput.setAttribute("value", key);
                            
                            //
                            
                            document.getElementById("contentModules").appendChild(checkboxDiv);
                            checkboxDiv.appendChild(checkboxLabel);
                            checkboxLabel.appendChild(checkboxInput);
                            checkboxLabel.appendChild(document.createTextNode(dataParse[key]));
                        }
                    }
                });
            });
            
            // Génération de l'URL du calendrier en fonction des paramètres du formulaire
            document.getElementById("params").addEventListener("change", function (e) {
                // Récupération de l'input contenant le résultat
                var result = document.getElementById("inputResultat");
                
                // Base de l'URL
                result.value = window.location.href;
                result.value += "calendar.php";
                result.value += "?";

                // Ajout du paramètre semestre
                result.value += "semester=";
                result.value += document.getElementById("selectSemestre").value;

                // Ajout du paramètre groupe de TD (si précisé)
                if(document.getElementById("selectGroupe").value != "")
                {
                    result.value += "&";

                    result.value += "group=";
                    result.value += document.getElementById("selectGroupe").value;
                }

                // Ajout du paramètre filtres
                result.value += "&";

                result.value += "filters=";
                var mod = document.getElementsByName('modules[]');
                for(var i = 0 ; i < mod.length ; i++) {
                    if(mod[i].checked == 1)
                    {
                        result.value += mod[i].value;
                        result.value += ",";
                    }
                }
                
                // Suppresion de la virgule de fin inutile
                if(result.value.charAt(result.value.length-1) != "=")
                {
                    result.value = result.value.substring(0,result.value.length-1);
                }
                
                // Suppression du paramètre inutile (parce que vide..)
                else
                {
                    result.value = result.value.substring(0,result.value.length-9);
                }
                
                // Choix de la salle d'anglais
                if(document.getElementById("checkboxeAnglais").checked == 1)
                {
                    result.value += "&";

                    result.value += "anglais=";
                    result.value += document.getElementById("inputAnglais").value;
                }

                // Affichage des sous-groupes spécifiques au S6
                if(document.getElementById("selectSemestre").value == "IN601")
                {
                    // Affichage des sous-groupes de BD si la BD n'est pas filtrée
                    if(document.getElementById("checkboxes-J1IN6013").checked == 0)
                    {
                        document.getElementById("divGroupeBD").style.display = "block";
                        
                        result.value += "&";

                        result.value += "groupBD=";
                        if(document.getElementById("groupeBD-1").checked == 1)
                            result.value += "1";
                        if(document.getElementById("groupeBD-2").checked == 1)
                            result.value += "2";
                    }
                    else
                    {
                        document.getElementById("divGroupeBD").style.display = "none";
                    }

                    // Affichage du "groupe 4" d'Algo si l'Algo n'est pas filtré
                    if(document.getElementById("checkboxes-J1IN6011").checked == 0)
                    {
                        document.getElementById("divGroupeAlgo").style.display = "block";
                        
                        result.value += "&";

                        result.value += "groupAlgo=";
                        if(document.getElementById("groupeAlgo-4").checked == 1)
                            result.value += "4";
                        if(document.getElementById("groupeAlgo-0").checked == 1)
                            result.value += "0";
                    }
                    else
                    {
                        document.getElementById("divGroupeAlgo").style.display = "none";
                    }

                    // Affichage du "groupe 4" d'analyse syntaxique si l'analyse syntaxique n'est pas filtrée
                    if(document.getElementById("checkboxes-J1IN6012").checked == 0)
                    {
                        document.getElementById("divGroupeAS").style.display = "block";
                        
                        result.value += "&";

                        result.value += "groupAS=";
                        if(document.getElementById("groupeAS-4").checked == 1)
                            result.value += "4";
                        if(document.getElementById("groupeAS-0").checked == 1)
                            result.value += "0";
                    }
                    else
                    {
                        document.getElementById("divGroupeAS").style.display = "none";
                    }
                }
            });

            // Affichage des sous-groupes spécifiques au S6 et de la liste des groupes
            document.getElementById("selectSemestre").addEventListener("change", function (e) {
                // Affichage des sous-groupes spécifiques au S6
                var semestre = e.target[e.target.selectedIndex].value;
                var groupes = document.getElementById("selectGroupe");
                var max = 4;
                if (semestre == "IN601") {
                    document.getElementById("divSousGroupes").style.display = "block";
                    max = 3;
                } else {
                    document.getElementById("divSousGroupes").style.display = "none";
                }

                // Affichage de la liste des groupes
                while (groupes.firstChild) {
                    groupes.removeChild(groupes.firstChild);
                }

                var option = document.createElement("option");
                option.setAttribute("value", "");
                option.setAttribute("selected", "selected");
                option.setAttribute("disabled", "disabled");
                option.setAttribute("hidden", "hidden");
                option.innerHTML = "Groupe";
                groupes.appendChild(option);

                for (var i = 1; i <= max; i++) {
                    var option = document.createElement("option");
                    option.value = i;
                    option.innerHTML = "Groupe " + i;
                    groupes.appendChild(option);
                }
                document.getElementById("divGroupe").style.display = "block";
            });
        </script>
    </body>
</html>